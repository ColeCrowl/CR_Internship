<#
.SYNOPSIS
   The script automates the fix for SSL Certificate Cannot Be Trusted

.NOTES
    Author          : Cole Crowl
    LinkedIn        : https://www.linkedin.com/in/colecrowl/
    GitHub          : https://github.com/ColeCrowl/ColeCrowl
    Date Created    : 2025-07-07
    Last Modified   : 2025-07-07
    Version         : 1.0
    CVEs            : N/A
    Plugin IDs      : N/A
    VM              : SSL Certificate Cannot Be Trusted

.TESTED ON
    Date(s) Tested  : 2025-07-07
    Tested By       : Cole Crowl
    Systems Tested  : Windows 10 Pro 6.3
    PowerShell Ver. :  5.1.26100.4652 

.USAGE
    Put any usage instructions here.
    Example syntax:
    PS C:\> .\__remediation_template(SSLCertNonTrust).ps1 
#>

#
# PowerShell script to automatically synchronize the system clock with a time server.
# This is a common solution for "SSL Certificate Cannot Be Trusted" errors
# caused by an incorrect system date and time.
#
# The script requires Administrator privileges to modify system settings.
#

# --- Function to check for administrator privileges ---
function Test-AdminPrivileges {
    $isUserAdmin = (New-Object System.Security.Principal.WindowsPrincipal([System.Security.Principal.WindowsIdentity]::GetCurrent())).IsInRole([System.Security.Principal.WindowsBuiltInRole]::Administrator)
    if (-not $isUserAdmin) {
        Write-Error "This script must be run with Administrator privileges. Please right-click PowerShell ISE and select 'Run as Administrator'."
        return $false
    }
    return $true
}

# --- Main Script Logic ---
if (Test-AdminPrivileges) {
    Write-Host "Starting system time synchronization process..."

    # Configure the Windows Time service to use an internet time server.
    Write-Host "Enabling automatic time synchronization..."
    try {
        # This command enables time sync for the service.
        w32tm /config /syncfromflags:manual /manualpeerlist:"time.windows.com"
        # This command forces the service to re-register its configuration.
        w32tm /register
        # This command forces the service to start.
        net start w32time
        Write-Host "Automatic time synchronization has been configured."
    } catch {
        Write-Error "Failed to configure Windows Time service. Error: $_"
        return
    }

    # Force an immediate resynchronization.
    Write-Host "Forcing an immediate time resynchronization..."
    try {
        w32tm /resync /force
        Write-Host "Time resynchronization request sent. Please wait a moment for it to complete."
    } catch {
        Write-Error "Failed to force time resynchronization. Error: $_"
        return
    }

    Write-Host "`nSystem time synchronization script has finished."
    Write-Host "You can verify the current time on your computer. If the 'SSL Certificate Cannot Be Trusted' error persists, please refer to the other steps in the troubleshooting guide."
}
